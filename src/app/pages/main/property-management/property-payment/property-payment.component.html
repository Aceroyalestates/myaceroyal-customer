<main class="flex flex-col w-full">


    @if (isLoading) {
    <div class="flex items-center justify-center py-20">
        <div
        class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"
        ></div>
    </div>
    }
  <div class="flex flex-col mb-10" *ngIf="propertyPurchaseDetails">
    <div class="mb-16">
      <app-breadcrumb
        [items]="[
          { label: 'Property Management', url: '/main/property-management' },
          { label: propertyPurchaseDetails.unit.property.name }
        ]"
      ></app-breadcrumb>
    </div>

   <div class="flex flex-col gap-8">
     <div class="mb-8 md:mb-16">
    <app-image-slider
      [images]="propertyImages"
      [showIndicators]="true"
      [showNavigation]="true"
      [showImageCounter]="true"
      [height]="sliderHeight"
      [objectFit]="'cover'"
      [borderRadius]="'8px'"
      [enableKeyboardNavigation]="true"
      [enableSwipeNavigation]="true"
      (imageChange)="onImageChange($event)"
      (imageClick)="onImageClick($event)"
    ></app-image-slider>
  </div>

    <div class="flex flex-col gap-2">
        <h3 class="text-xl font-semibold !text-gray-600">{{ propertyPurchaseDetails.unit.property.name }}</h3>
        <h1 class="text-2xl !font-bold !text-gray-600">{{ propertyPurchaseDetails.initial_payment_due | currency: '₦ ' }}</h1>
    </div>
    <div class="flex flex-col gap-3 px-4 py-6 bg-primary rounded-lg !text-white w-fit">
        <div class="flex justify-between">
            <div class="flex gap-2 items-center">
                <app-icon class="" name="tag"></app-icon>
                <p class="text-sm"> Number of Units </p>
            </div>
            <p>{{ propertyPurchaseDetails.quantity }}</p>
        </div>
        <div class="flex gap-20 justify-between">
            <div class="flex gap-2 items-center">
                <app-icon class="" name="credit-card"></app-icon>
                <p class="text-sm"> Payment Option </p>
            </div>
            <p class="text-sm">{{ propertyPurchaseDetails.payment_method }}</p>
        </div>
        <div class="flex justify-between">
            <div class="flex gap-2 items-center">
                <app-icon class="" name="circle"></app-icon>
                <p class="text-sm"> Payment Status </p>
            </div>
            <p class="text-sm !text-white-400 !font-normal bg-red-500 rounded-full !px-4">{{ propertyPurchaseDetails.status }}</p>
        </div>
    </div>

    <!-- <h1 class="text-xl font-semibold !text-gray-600">Realtor Details</h1> -->
    <!-- <div class="flex justify-between pr-24">
        <div class="flex flex-col">
            <h3 class=" !text-gray-500">Full Name</h3>
            <p class=" !text-gray-500">Endurance Racheal</p>
        </div>
        <div class="flex flex-col">
            <h3 class=" !text-gray-500">Contact Info</h3>
            <p class=" !text-gray-500">endurance&#64;example.com</p>
        </div>
        <div class="flex flex-col">
            <h3 class=" !text-gray-500">Liscence No</h3>
            <p class=" !text-gray-500">AC-123456789</p>
        </div>
        <div class="flex flex-col">
            <h3 class=" !text-gray-500">Date Assigned</h3>
            <p class=" !text-gray-500">12-07-2023</p>
        </div>
    </div>

    <div class="flex gap-2 items-center">
        <input type="checkbox" name="consent" id="consent" class="!text-primary !bg-primary !text-sm">
        <p class="!text-gray-500">I hereby give consent for my realtor to manage this property, conduct activities on my behalf relating to this property</p>
    </div> -->

    <!-- <h1 class="text-xl font-semibold !text-primary border-b-2 border-primary w-fit cursor-pointer">Request Realtor Change</h1> -->

    <div class="flex justify-between items-center w-full md:w-2/3">
        <h1 class="text-xl font-semibold !text-gray-600" *ngIf="propertyPurchaseDetails.schedules.length > 0">Payment Schedule</h1>
        <!-- Refresh button -->
        <button nz-button nzType="default" class="!text-gray-500 !bg-transparent hover:!bg-gray-100" (click)="getUserSchedules(id!)">
            <!-- <app-icon name="refresh" class="!text-gray-500"></app-icon> -->
            Refresh
        </button>
    </div>

    <div class="flex flex-col gap-4">
        @for(schedule of schedules; track schedule.id) {
            <div class="flex flex-col w-full md:w-2/3 border border-gray-200 rounded-lg p-4 gap-4 bg-white">
                <div class="flex justify-between items-center pb-4">
                    <h1 class="!text-gray-600">{{ schedule.installment_number + '/' + schedules.length }} Installment</h1>
                    @if(schedule.status === 'paid') {
                        <p class="!px-10 bg-green-50 !text-green-500 border border-green-200 rounded-full"> {{ schedule.status }} </p>
                    } @else {
                        <p class="!px-8 bg-yellow-50 !text-yellow-500 border border-yellow-200 rounded-full"> {{ schedule.status }} </p>
                    }
                </div>
                <div class="flex justify-between items-center">
                    <div class="flex gap-2 items-center !text-gray-500">
                        <app-icon class="!text-gray-400" name="credit-card"></app-icon>
                        Amount Due
                    </div>
                    <p class="!text-gray-500 !font-semibold">{{ schedule.amount_due - schedule.amount_paid | currency: '₦' }}</p>
                </div>
                <div class="flex justify-between items-center" *ngIf="schedule.amount_paid > 0 && schedule.status === 'partial'">
                    <div class="flex gap-2 items-center !text-gray-500">
                        <app-icon class="!text-gray-400" name="credit-card"></app-icon>
                        Amount Paid
                    </div>
                    <p class="!text-gray-500 !font-semibold">{{ schedule.amount_paid | currency: '₦' }}</p>
                </div>
                <div class="flex justify-between items-center">
                    <div class="flex gap-2 items-center !text-gray-500">
                        <app-icon class="!text-gray-400" name="calendar"></app-icon>
                        Date Due
                    </div>
                    <p class="!text-gray-500 !font-semibold"> {{ schedule.due_date | date:'dd/MM/yyyy' }} </p>
                </div>

                @if(schedule.status === 'pending' || schedule.status === 'partial') {
                    <button
                     class="!mt-4 !bg-primary !text-white !px-6 !py-2 !rounded-full w-fit cursor-pointer"
                     (click)="showPaymentMethodModal(schedule)"
                     >Make Payment</button>
                }
            </div>
            <!-- naira symbol -->
             <!-- <h1> ₦ </h1> -->
        }
    </div>
   </div>


   <!-- Payment Method Modal -->
    <nz-modal
      [(nzVisible)]="isPaymentMethodModalVisible"
      nzTitle="Payment Method"
      [nzOkLoading]="isLoading"
    >
      <div *nzModalContent>
        
        <div class="flex flex-col w-80">
          <h1 for="paymentMethod" class="!mb-2 !text-gray-500">Amount</h1>
          <h2 class="!text-gray-600 text-normal text-[20px] whitespace-nowrap !mb-6">
            {{
                finalAmount | currency:'₦ ':'symbol':'1.0-0'
            }}
          </h2>

          <div class="flex flex-col w-full mt-4">
            <label for="enteredAmount" class="mb-2 font-medium text-gray-500">Enter amount you want to pay</label>
            <nz-form-control>
              <input
                nz-input
                id="enteredAmount"
                type="text"
                [(ngModel)]="enteredAmount"
                [placeholder]="'Enter Amount'"
                class="w-full"
                [currencyMask]="{ prefix: '₦ ', thousands: ',', decimal: '.', align: 'left' }"
              />
            </nz-form-control>
          </div>

          <nz-radio-group [(ngModel)]="selectedPaymentMethod" class="!mt-6 flex flex-col !items-center !gap-6 !text-gray-500">
            <label nz-radio [nzValue]="1" class="flex !items-center !mb-4 !text-primary"> 
              <div class="flex !items-center !gap-8"> 
                <div class="p-2 bg-red-100 rounded-full">
                  <app-icon name="home" class="!text-primary" />
                </div> 
                <span class="!text-gray-500">Bank Transfer </span>
              </div> 
            </label>
            <!-- only show paystack if amount is 100000000 or less -->
            <label nz-radio [nzValue]="2" class="flex !items-center !mb-4" *ngIf="(enteredAmount || currentSchedule?.amount_due) <= 100000000"> 
              <div class="flex !items-center !gap-8"> 
                <div class="p-2 bg-red-100 rounded-full">
                  <app-icon name="credit-card" class="!text-primary" />
                </div> 
                <span class="!text-gray-500">Pay with Paystack </span>
              </div> 
            </label>
            <label nz-radio [nzValue]="3" class="flex !items-center !mb-4"> 
              <div class="flex !items-center !gap-8"> 
                <div class="p-2 bg-red-100 rounded-full">
                  <app-icon name="credit-card" class="!text-primary" />
                </div> 
                <span class="!text-gray-500">Bank Draft </span>
              </div> 
            </label>
          </nz-radio-group>
          
        </div>
      </div>
      <div *nzModalFooter>
        <button class="!rounded !text-gray-500 hover:!border-primary" nz-button nzType="default" (click)="handleCancel()" [disabled]="isLoading">Cancel</button>
        <button class="!rounded !bg-primary !border-none !text-white disabled:opacity-50" nz-button nzType="primary" (click)="handlePaymentMethodOk()" [nzLoading]="isLoading" [disabled]="isLoading" [disabled]="!selectedPaymentMethod">Continue</button>
      </div>
    </nz-modal>

        <!-- Bank Transfer Modal -->
    <nz-modal
      [(nzVisible)]="isBankTransferModalVisible"
      nzTitle="Bank Transfer"
      (nzOnCancel)="handleCancel()"
      (nzOnOk)="handleBankTransferOk()"
      [nzOkLoading]="isLoading"
    >
      <div *nzModalContent>

        <h1 for="paymentMethod" class="!mb-2 !text-gray-500">Amount</h1>
        <h2 class="!text-gray-600 text-normal text-[20px] whitespace-nowrap !mb-6">
          {{
                finalAmount | currency:'₦ ':'symbol':'1.0-0'
           }}
        </h2>

        <p class="!text-gray-500 text-sm">Kindly make bank transfer to any of the bank account details below, Kindly note that after making payment, we would have to verify your payment before your transaction will be considered successful.</p>

        @if(property.accounts && property.accounts.length > 10) {
          @if(property.accounts.length === 1) {
            <div class="flex flex-col gap-4 !text-gray-500 !mt-6">
                <div class="flex flex-col">
                  <h1 class="!text-gray-600">Bank Name</h1>
                  <h2 class="!text-gray-400"> {{ property.accounts[0].bank_name }} ({{ property.accounts[0].account_type }}) </h2>
                </div>

                <div class="flex flex-col">
                  <h1 class="!text-gray-600">Account Name</h1>
                  <h2 class="!text-gray-400"> {{ property.accounts[0].account_name }} </h2>
                </div>

                <div class="flex flex-col gap-2">
                    
                    <h1 class="!text-gray-600">Account Number</h1>
                    <div class="flex items-center gap-4">
                      <span class="bg-red-100 p-2 rounded-full !text-primary">₦</span>
                      <h2 class="!text-gray-400"> {{ property.accounts[0].account_number }} </h2>
                      <button 
                      class="!text-gray-400 !bg-transparent !border-none hover:!text-primary" 
                      (click)="copyToClipboard(property.accounts[0].account_number)" 
                      nz-button 
                      nzType="default" 
                      nzSize="small" 
                      nzTooltipTitle="Copy to clipboard"
                      nzTooltipPlacement="top"
                      >
                        <app-icon name="copy"></app-icon>
                      </button>
                    </div>
                    
                </div>
              </div>
          }
          @else {
            <nz-tabset>
          @for(acc of property.accounts; track acc.id) {
            <nz-tab nzTitle="{{ acc.bank_name }}">
              <div class="flex flex-col gap-4 !text-gray-500 !mt-6">
                <div class="flex flex-col">
                  <h1 class="!text-gray-600">Bank Name</h1>
                  <h2 class="!text-gray-400"> {{ acc.bank_name }} ({{ acc.account_type }}) </h2>
                </div>

                <div class="flex flex-col">
                  <h1 class="!text-gray-600">Account Name</h1>
                  <h2 class="!text-gray-400"> {{ acc.account_name }} </h2>
                </div>

                <div class="flex flex-col gap-2">
                    
                    <h1 class="!text-gray-600">Account Number</h1>
                    <div class="flex items-center gap-4">
                      <span class="bg-red-100 p-2 rounded-full !text-primary">₦</span>
                      <h2 class="!text-gray-400"> {{ acc.account_number }} </h2>
                      <button 
                      class="!text-gray-400 !bg-transparent !border-none hover:!text-primary" 
                      (click)="copyToClipboard(acc.account_number)" 
                      nz-button 
                      nzType="default" 
                      nzSize="small" 
                      nzTooltipTitle="Copy to clipboard"
                      nzTooltipPlacement="top"
                      >
                        <app-icon name="copy"></app-icon>
                      </button>
                    </div>
                    
                </div>
              </div>
            </nz-tab>
          }
        </nz-tabset>
          }
        }
        @else {
          <nz-tabset>
          @for(acc of defaultBankAccounts; track acc.account_number) {
            <nz-tab nzTitle="{{ acc.bank_name }}">
              <div class="flex flex-col gap-4 !text-gray-500 !mt-6">
                <div class="flex flex-col">
                  <h1 class="!text-gray-600">Bank Name</h1>
                  <h2 class="!text-gray-400"> {{ acc.bank_name }} </h2>
                </div>

                <div class="flex flex-col">
                  <h1 class="!text-gray-600">Account Name</h1>
                  <h2 class="!text-gray-400"> {{ acc.account_name }} </h2>
                </div>

                <div class="flex flex-col gap-2">
                    
                    <h1 class="!text-gray-600">Account Number</h1>
                    <div class="flex items-center gap-4">
                      <span class="bg-red-100 p-2 rounded-full !text-primary">₦</span>
                       <!-- Bank small icon -->
                      <!-- <img [src]="acc.icon_url" alt="{{ acc.bank_name }}" class="h-8 w-8 object-contain"/> -->
                      <h2 class="!text-gray-400"> {{ acc.account_number }} </h2>
                      <button 
                      class="!text-gray-400 !bg-transparent !border-none hover:!text-primary" 
                      (click)="copyToClipboard(acc.account_number)" 
                      nz-button 
                      nzType="default" 
                      nzSize="small" 
                      nzTooltipTitle="Copy to clipboard"
                      nzTooltipPlacement="top"
                      >
                        <app-icon name="copy"></app-icon>
                      </button>
                    </div>
                    
                </div>
              </div>
            </nz-tab>
        }
        </nz-tabset>
        }

        
      </div>
      <div *nzModalFooter>
        <button class="!rounded !text-gray-500 hover:!border-primary" nz-button nzType="default" (click)="handleCancel()" [disabled]="isLoading">Cancel</button>
        <button class="!rounded !bg-primary !border-none !text-white disabled:opacity-50" nz-button nzType="primary" (click)="handleBankTransferOk()" [nzLoading]="isLoading" [disabled]="isLoading">Continue</button>
      </div>
    </nz-modal>

    <!-- Bank Cheque Modal -->
    <nz-modal
      [(nzVisible)]="isBankChequeModalVisible"
      nzTitle="Bank Cheque"
      (nzOnCancel)="handleCancel()"
      (nzOnOk)="handleBankChequeOk()"
      [nzOkLoading]="isLoading"
    >
      <div *nzModalContent>
        
        <h1 for="paymentMethod" class="!mb-2 !text-gray-500">Amount</h1>
        <h2 class="!text-gray-600 text-normal text-[20px] whitespace-nowrap !mb-6">
          {{
            finalAmount | currency:'₦ ':'symbol':'1.0-0'
        }}
        </h2>

        <p class="!text-gray-500 text-sm">Kindly note that we would need to verify and make sure that the cheque has been cleared before this can be referred to as a successful transaction.</p>

        <p class="!text-gray-500 text-sm">Kindly write the cheque/Bank Draft in the name of </p>
        <span class="text-primary">ACEROYAL ESTATE HOMES LTD. </span>
        
      </div>
      <div *nzModalFooter>
        <button class="!rounded !text-gray-500 hover:!border-primary" nz-button nzType="default" (click)="handleCancel()" [disabled]="isLoading">Cancel</button>
        <button class="!rounded !bg-primary !border-none !text-white disabled:opacity-50" nz-button nzType="primary" (click)="handleBankChequeOk()" [nzLoading]="isLoading" [disabled]="isLoading">Continue</button>
      </div>
    </nz-modal>

    <!-- Payment Success Modal -->
    <nz-modal
      [(nzVisible)]="isPaymentSuccessModalVisible"
      nzTitle=""
      (nzOnCancel)="handleCancel()"
      (nzOnOk)="handlePaymentSuccessOk()"
      [nzOkLoading]="isLoading"
    >
      <div *nzModalContent>
        <div class="flex justify-center my-6 bg-red-50 p-2 rounded-full w-fit mx-auto">
          <div class="flex justify-center items-center bg-red-100 p-4 rounded-full">
            <app-icon name="check" class="!text-primary !text-2xl"></app-icon>
          </div>
        </div>
        <h1 class="!text-gray-600 justify-center text-center text-lg font-semibold !my-4">SUCCESS</h1>
        <div class="relative flex items-center justify-center cursor-pointer border border-gray-400 w-full rounded-lg hover:bg-gray-100 !px-4 !mb-4">
          <input
              type="file"
              id="fileInput"
              (change)="onFileSelected($event)"
              class="absolute inset-0 w-full h-full opacity-0 cursor-pointer disabled:cursor-not-allowed"
              [disabled]="isLoading"
              accept="image/*, application/pdf"
          />
          <label for="fileInput" class="flex justify-center w-fit px-4 py-2 rounded cursor-pointer">
              Upload your payment receipt (Image or PDF)
          </label>
        </div>
        @if (selectedFile) {
          <p class="!text-gray-500 text-sm !my-2 text-center">Selected file: {{ selectedFile.name }}</p>
        }

        <div class="flex items-center gap-4">
          <app-icon name="info" class="!text-gray-400 !text-xl"></app-icon>
          <p class="!text-gray-500 text-sm">Please kindly note that you need to fill our purchase form before your property allocation can be completed.</p>
        </div>
      </div>
      <div *nzModalFooter>
        <button class="!rounded !text-gray-500 hover:!border-primary" nz-button nzType="default" (click)="handleCancel()" [disabled]="isLoading">Cancel</button>
        <button class="!rounded !bg-primary !border-none !text-white disabled:opacity-50" nz-button nzType="primary" (click)="handlePaymentSuccessOk()" [nzLoading]="isLoading" [disabled]="isLoading || !selectedFile">Continue</button>
      </div>
    </nz-modal>


  </div>
 
</main>
